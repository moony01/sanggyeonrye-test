# Canvas API ê²°ê³¼ ì´ë¯¸ì§€ ìƒì„± ê¸°ëŠ¥

> K-Pop Face Test ê²°ê³¼ë¥¼ ê³µìœ ìš© ì´ë¯¸ì§€ë¡œ ìƒì„±í•˜ëŠ” ê¸°ëŠ¥ ëª…ì„¸

## 1. ê°œìš”

### ëª©ì 
ì‚¬ìš©ìê°€ í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ **ì´ë¯¸ì§€ë¡œ ì €ì¥/ê³µìœ **í•˜ì—¬ ë°”ì´ëŸ´ ë§ˆì¼€íŒ… íš¨ê³¼ ê·¹ëŒ€í™”

### ì™œ Canvas APIì¸ê°€?

| ë°©ë²• | ì¥ì  | ë‹¨ì  | ë¹„ìš© |
|------|------|------|------|
| **Canvas API** | ì„œë²„ ë¶ˆí•„ìš”, ì¦‰ì‹œ ìƒì„± | ì´ˆê¸° ê°œë°œ í•„ìš” | **0ì›** |
| html2canvas | êµ¬í˜„ ì‰¬ì›€ | í’ˆì§ˆ ë‚®ìŒ, í°íŠ¸ ê¹¨ì§ | 0ì› |
| ì„œë²„ ìƒì„± (Puppeteer) | í’ˆì§ˆ ìµœìƒ | ì„œë²„ ë¹„ìš©, ì†ë„ ëŠë¦¼ | Lambda ê³¼ê¸ˆ |
| Canva API | í…œí”Œë¦¿ ì´ì¨ | API ë¹„ìš© | ì›” $30+ |

**ê²°ë¡ **: Zero-Cost ì² í•™ì— Canvas APIê°€ ìµœì 

---

## 2. ê¸°ìˆ  ìŠ¤í™

### í”„ë¡œì íŠ¸ êµ¬ì¡° (Jekyll ê¸°ì¤€)

```
/kpopface
â”œâ”€â”€ /static
â”‚   â”œâ”€â”€ /js
â”‚   â”‚   â”œâ”€â”€ app.js              # ê¸°ì¡´ ë©”ì¸ ë¡œì§
â”‚   â”‚   â””â”€â”€ imageGenerator.js   # Canvas ì´ë¯¸ì§€ ìƒì„± (ì‹ ê·œ)
â”‚   â””â”€â”€ /img
â”‚       â””â”€â”€ /agency             # ì†Œì†ì‚¬ ì•„ì´ì½˜ (ì‹ ê·œ)
â”‚           â”œâ”€â”€ sm.png
â”‚           â”œâ”€â”€ jyp.png
â”‚           â””â”€â”€ yg.png
â”œâ”€â”€ /_layouts
â”‚   â””â”€â”€ default.html            # í°íŠ¸ ë¡œë“œ ì¶”ê°€
â””â”€â”€ index.html                  # ë²„íŠ¼ UI ì¶”ê°€
```

### ì´ë¯¸ì§€ ì‚¬ì–‘

| í•­ëª© | ê°’ | ë¹„ê³  |
|------|-----|------|
| í¬ê¸° | 1080 x 1920px | ì¸ìŠ¤íƒ€ ìŠ¤í† ë¦¬ ë¹„ìœ¨ (9:16) |
| í¬ë§· | PNG | íˆ¬ëª…ë„ ë¶ˆí•„ìš” |
| ìš©ëŸ‰ | ~500KB ì´í•˜ | ëª¨ë°”ì¼ ê³µìœ  ìµœì í™” |

---

## 3. ì†Œì†ì‚¬ë³„ í…Œë§ˆ ìƒ‰ìƒ

| ì†Œì†ì‚¬ | ë©”ì¸ ìƒ‰ìƒ | ì„œë¸Œ ìƒ‰ìƒ | ë¹„ê³  |
|--------|----------|----------|------|
| SM | `#0066FF` | `#00D4FF` | íŒŒë€ ê³„ì—´ |
| JYP | `#00C853` | `#69F0AE` | ì´ˆë¡ ê³„ì—´ |
| YG | `#212121` | `#616161` | ë¸”ë™ ê³„ì—´ |
| HYBE | `#6B46C1` | `#EC4899` | ë³´ë¼-í•‘í¬ |

---

## 4. êµ¬í˜„ ì½”ë“œ

### 4.1 ì´ë¯¸ì§€ ìƒì„± í•¨ìˆ˜ (static/js/imageGenerator.js)

```javascript
/**
 * Canvas APIë¡œ K-Pop Face Test ê²°ê³¼ ì´ë¯¸ì§€ ìƒì„±
 * 
 * @param {Object} data - ê²°ê³¼ ë°ì´í„°
 * @param {string} data.agency - ì†Œì†ì‚¬ ì½”ë“œ (sm, jyp, yg, hybe)
 * @param {string} data.title - ê²°ê³¼ ì œëª© (ì˜ˆ: "SMì–¼êµ´ìƒ")
 * @param {string} data.explain - í•´ì‹œíƒœê·¸ ì„¤ëª…
 * @param {string} data.celeb - ëŒ€í‘œ ì—°ì˜ˆì¸
 * @param {string} data.lang - ì–¸ì–´ ì½”ë“œ
 * @returns {Promise<Blob>} PNG ì´ë¯¸ì§€ Blob
 */
async function generateResultImage(data) {
  const { agency, title, explain, celeb, lang } = data;
  
  // í°íŠ¸ ë¡œë“œ ëŒ€ê¸°
  if (document.fonts) {
    await document.fonts.ready;
  }

  // 1. Canvas ìƒì„± (ì¸ìŠ¤íƒ€ ìŠ¤í† ë¦¬ ë¹„ìœ¨)
  const canvas = document.createElement('canvas');
  canvas.width = 1080;
  canvas.height = 1920;
  const ctx = canvas.getContext('2d');

  // 2. ì†Œì†ì‚¬ë³„ ë°°ê²½ ê·¸ë¼ë°ì´ì…˜
  const colors = getAgencyColors(agency);
  const gradient = ctx.createLinearGradient(0, 0, 0, 1920);
  gradient.addColorStop(0, colors.main);
  gradient.addColorStop(1, colors.sub);
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, 1080, 1920);

  // 3. ìƒë‹¨ ë¡œê³ 
  ctx.fillStyle = '#FFFFFF';
  ctx.font = 'bold 55px Pretendard, sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('K-POP Face Test', 540, 180);

  // 4. ì†Œì†ì‚¬ ë¡œê³ /ì•„ì´ì½˜
  try {
    const icon = await loadImage(`/kpopface/static/img/agency/${agency}.png`);
    ctx.drawImage(icon, 390, 400, 300, 300);
  } catch (e) {
    // ì•„ì´ì½˜ ì—†ìœ¼ë©´ ì´ëª¨ì§€ ëŒ€ì²´
    ctx.font = '180px sans-serif';
    ctx.fillText(getAgencyEmoji(agency), 540, 600);
  }

  // 5. ê²°ê³¼ í…ìŠ¤íŠ¸
  ctx.font = 'bold 90px Pretendard, sans-serif';
  ctx.fillStyle = '#FFFFFF';
  ctx.fillText(title, 540, 850);

  // 6. í•´ì‹œíƒœê·¸
  ctx.font = '42px Pretendard, sans-serif';
  ctx.fillStyle = '#F0F0F0';
  wrapText(ctx, explain, 540, 960, 900, 55);

  // 7. ëŒ€í‘œ ì—°ì˜ˆì¸ (ì¶•ì•½)
  ctx.font = '36px Pretendard, sans-serif';
  ctx.fillStyle = '#E0E0E0';
  const shortCeleb = celeb.length > 60 ? celeb.substring(0, 60) + '...' : celeb;
  wrapText(ctx, shortCeleb, 540, 1200, 900, 50);

  // 8. í•˜ë‹¨ CTA
  ctx.font = 'bold 50px Pretendard, sans-serif';
  ctx.fillStyle = '#FFED4E';
  const ctaText = lang === 'ko' ? 'ë‚˜ë„ í…ŒìŠ¤íŠ¸ í•˜ê¸°!' : 'Try the test!';
  ctx.fillText(ctaText, 540, 1650);

  // 9. URL ì›Œí„°ë§ˆí¬
  ctx.font = '40px Pretendard, sans-serif';
  ctx.fillStyle = '#FFFFFF';
  ctx.fillText('moony01.com/kpopface', 540, 1750);

  // 10. PNG Blob ë°˜í™˜
  return new Promise((resolve) => {
    canvas.toBlob(resolve, 'image/png', 1.0);
  });
}

// ì†Œì†ì‚¬ë³„ ìƒ‰ìƒ ë°˜í™˜
function getAgencyColors(agency) {
  const colorMap = {
    sm: { main: '#0066FF', sub: '#00D4FF' },
    jyp: { main: '#00C853', sub: '#69F0AE' },
    yg: { main: '#212121', sub: '#616161' },
    hybe: { main: '#6B46C1', sub: '#EC4899' }
  };
  return colorMap[agency] || colorMap.hybe;
}

// ì†Œì†ì‚¬ë³„ ëŒ€ì²´ ì´ëª¨ì§€
function getAgencyEmoji(agency) {
  const emojiMap = { sm: 'ğŸ’™', jyp: 'ğŸ’š', yg: 'ğŸ–¤', hybe: 'ğŸ’œ' };
  return emojiMap[agency] || 'ğŸ¤';
}

// ì´ë¯¸ì§€ ë¡œë“œ í—¬í¼
function loadImage(url) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = url;
  });
}

// í…ìŠ¤íŠ¸ ìë™ ì¤„ë°”ê¿ˆ
function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
  const words = text.split(' ');
  let line = '';
  let currentY = y;

  words.forEach((word) => {
    const testLine = line + word + ' ';
    const metrics = ctx.measureText(testLine);
    if (metrics.width > maxWidth && line !== '') {
      ctx.fillText(line.trim(), x, currentY);
      line = word + ' ';
      currentY += lineHeight;
    } else {
      line = testLine;
    }
  });
  ctx.fillText(line.trim(), x, currentY);
}
```

### 4.2 ê³µìœ /ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ (static/js/app.jsì— ì¶”ê°€)

```javascript
// ê²°ê³¼ ì´ë¯¸ì§€ ì €ì¥/ê³µìœ 
async function fnSaveResultImage() {
  const saveBtn = document.getElementById('save-image-btn');
  if (saveBtn) saveBtn.disabled = true;

  try {
    // í˜„ì¬ ê²°ê³¼ ë°ì´í„° ìˆ˜ì§‘
    const data = {
      agency: currentAgency,      // predict()ì—ì„œ ì„¤ì •í•œ ì „ì—­ ë³€ìˆ˜
      title: currentResultTitle,
      explain: currentResultExplain,
      celeb: currentResultCeleb,
      lang: langType || 'ko'
    };

    // Canvasë¡œ ì´ë¯¸ì§€ ìƒì„±
    const imageBlob = await generateResultImage(data);
    const imageFile = new File([imageBlob], 'kpop-face-result.png', { type: 'image/png' });

    // ëª¨ë°”ì¼: Web Share API
    if (navigator.canShare && navigator.canShare({ files: [imageFile] })) {
      await navigator.share({
        files: [imageFile],
        title: 'K-POP Face Test Result',
        text: data.title
      });
    } else {
      // PC: ìë™ ë‹¤ìš´ë¡œë“œ
      const url = URL.createObjectURL(imageBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'kpop-face-result.png';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  } catch (error) {
    console.error('ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨:', error);
    alert('ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
  } finally {
    if (saveBtn) saveBtn.disabled = false;
  }
}
```

### 4.3 UI ë²„íŠ¼ (index.htmlì— ì¶”ê°€)

```html
<!-- ê²°ê³¼ ì´ë¯¸ì§€ ì €ì¥ ë²„íŠ¼ (file-upload-content ë‚´ë¶€) -->
<button type="button" id="save-image-btn" class="save-image-btn" onclick="fnSaveResultImage()">
  <span class="save-image-text">ê²°ê³¼ ì´ë¯¸ì§€ ì €ì¥í•˜ê¸°</span>
</button>
```

### 4.4 í°íŠ¸ ë¡œë“œ (_layouts/default.html <head>ì— ì¶”ê°€)

```html
<!-- Pretendard í°íŠ¸ (Canvas ë Œë”ë§ìš©) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
```

---

## 5. Canvas API í•µì‹¬ ë©”ì„œë“œ ì°¸ê³ 

| ë©”ì„œë“œ | ì—­í•  | ì‚¬ìš©ì²˜ |
|--------|------|--------|
| `fillRect(x, y, w, h)` | ì‚¬ê°í˜• ì±„ìš°ê¸° | ë°°ê²½ |
| `fillText(text, x, y)` | í…ìŠ¤íŠ¸ ì“°ê¸° | ì œëª©, ì„¤ëª… |
| `drawImage(img, x, y, w, h)` | ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° | ì†Œì†ì‚¬ ì•„ì´ì½˜ |
| `createLinearGradient()` | ê·¸ë¼ë°ì´ì…˜ | ë°°ê²½ íš¨ê³¼ |
| `canvas.toBlob()` | PNG ë³€í™˜ | ë‹¤ìš´ë¡œë“œ/ê³µìœ  |

---

## 6. ì²´í¬ë¦¬ìŠ¤íŠ¸

### êµ¬í˜„ ì „ ì¤€ë¹„
- [ ] ì†Œì†ì‚¬ ì•„ì´ì½˜ ì´ë¯¸ì§€ ì¤€ë¹„ (ë˜ëŠ” ì´ëª¨ì§€ ëŒ€ì²´ ê²°ì •)
- [ ] Pretendard í°íŠ¸ ë¡œë“œ ì¶”ê°€

### êµ¬í˜„
- [ ] `static/js/imageGenerator.js` ìƒì„±
- [ ] `app.js`ì— ì „ì—­ ë³€ìˆ˜ ì¶”ê°€ (currentAgency, currentResultTitle ë“±)
- [ ] `app.js`ì— fnSaveResultImage() ì¶”ê°€
- [ ] `index.html`ì— ì €ì¥ ë²„íŠ¼ ì¶”ê°€
- [ ] ë‹¤êµ­ì–´ë³„ CTA í…ìŠ¤íŠ¸ ì²˜ë¦¬

### í…ŒìŠ¤íŠ¸
- [ ] PC Chrome ë‹¤ìš´ë¡œë“œ í…ŒìŠ¤íŠ¸
- [ ] ëª¨ë°”ì¼ Web Share API í…ŒìŠ¤íŠ¸ (HTTPS í•„ìˆ˜)
- [ ] í°íŠ¸ ë Œë”ë§ í™•ì¸
- [ ] ì†Œì†ì‚¬ë³„ ìƒ‰ìƒ í™•ì¸

---

## 7. ì°¸ê³  ìë£Œ

- [MDN Canvas API](https://developer.mozilla.org/ko/docs/Web/API/Canvas_API)
- [Web Share API](https://developer.mozilla.org/en-US/docs/Web/API/Navigator/share)
- [Pretendard Font](https://github.com/orioncactus/pretendard)
